# AI病历质控系统 - 使用指南

## 🚀 快速开始

### 1. 启动应用

#### 方法一：使用启动脚本（推荐）
```bash
# Windows
start.bat

# 或者使用生产环境脚本
start-prod.bat
```

#### 方法二：直接命令行启动
```bash
# 开发环境启动
java -jar target/ai-medical-score-1.0.0-SNAPSHOT.jar

# 生产环境启动
java -jar target/ai-medical-score-1.0.0-SNAPSHOT.jar --spring.profiles.active=prod

# 指定端口启动
java -jar target/ai-medical-score-1.0.0-SNAPSHOT.jar --server.port=8080
```

### 2. 验证应用是否启动成功

打开浏览器或使用curl访问：
```
http://localhost:8080/actuator/health
```

看到以下响应表示启动成功：
```json
{
  "status": "UP",
  "components": {
    "db": {"status": "UP"},
    "diskSpace": {"status": "UP"},
    "ping": {"status": "UP"}
  }
}
```

## 📝 API接口使用示例

### 3. 生成AI病历评分

#### 接口地址
```
POST http://localhost:8080/api/ai-score/generate
```

#### 请求示例（使用curl）
```bash
curl -X POST http://localhost:8080/api/ai-score/generate \
  -H "Content-Type: application/json" \
  -d '{
    "patientId": "P001",
    "requestId": "REQ123456"
  }'
```

#### 请求示例（使用PowerShell）
```powershell
$body = @{
    patientId = "P001"
    requestId = "REQ123456"
} | ConvertTo-Json

Invoke-RestMethod -Uri "http://localhost:8080/api/ai-score/generate" `
  -Method POST `
  -ContentType "application/json" `
  -Body $body
```

#### 预期响应
```json
{
  "success": true,
  "data": {
    "patientId": "P001",
    "totalScore": 85,
    "level": "乙级",
    "scoreDetails": [
      {
        "dimension": "主诉",
        "score": 8,
        "maxScore": 10,
        "comment": "主诉描述清晰完整"
      },
      {
        "dimension": "病史",
        "score": 17,
        "maxScore": 20,
        "comment": "现病史记录详细，既往史完整"
      }
    ],
    "aiComment": "整体病历质量良好，建议加强体格检查记录的完整性",
    "createTime": "2025-07-04T15:30:00"
  },
  "message": "评分生成成功"
}
```

### 4. 查看评分报告

#### 接口地址
```
GET http://localhost:8080/api/ai-score/report/{patientId}
```

#### 请求示例
```bash
# curl
curl -X GET http://localhost:8080/api/ai-score/report/P001

# PowerShell
Invoke-RestMethod -Uri "http://localhost:8080/api/ai-score/report/P001" -Method GET
```

### 5. 保存专家点评

#### 接口地址
```
POST http://localhost:8080/api/ai-score/expert-comment
```

#### 请求示例
```bash
curl -X POST http://localhost:8080/api/ai-score/expert-comment \
  -H "Content-Type: application/json" \
  -d '{
    "patientId": "P001",
    "expertComment": "病历记录规范，诊断准确，建议加强治疗方案的个性化",
    "expertScore": 88,
    "expertName": "张医生"
  }'
```

## 🔧 测试用例和数据

### 6. 准备测试数据

创建测试脚本 `test-data.json`：
```json
{
  "patientId": "TEST001",
  "requestId": "REQ" + new Date().getTime(),
  "patientInfo": {
    "name": "张三",
    "age": 45,
    "gender": "男",
    "admissionDate": "2025-07-04"
  }
}
```

### 7. 批量测试脚本

创建 `batch-test.bat`：
```batch
@echo off
echo 开始批量测试AI病历评分系统...

echo.
echo 1. 测试健康检查...
curl -s http://localhost:8080/actuator/health

echo.
echo 2. 测试病历评分...
curl -X POST http://localhost:8080/api/ai-score/generate ^
  -H "Content-Type: application/json" ^
  -d "{\"patientId\":\"TEST001\",\"requestId\":\"REQ123\"}"

echo.
echo 3. 查看评分报告...
curl -X GET http://localhost:8080/api/ai-score/report/TEST001

echo.
echo 测试完成！
pause
```

## 🌐 浏览器测试

### 8. 使用浏览器测试

#### 健康检查
直接在浏览器中打开：
```
http://localhost:8080/actuator/health
```

#### 应用信息
```
http://localhost:8080/actuator/info
```

#### 监控指标
```
http://localhost:8080/actuator/metrics
```

### 9. 使用Postman测试

#### 导入Postman集合
创建 `AI-Medical-Score.postman_collection.json`：
```json
{
  "info": {
    "name": "AI病历质控系统",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "item": [
    {
      "name": "生成AI评分",
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"patientId\": \"P001\",\n  \"requestId\": \"REQ123456\"\n}"
        },
        "url": {
          "raw": "{{baseUrl}}/api/ai-score/generate",
          "host": ["{{baseUrl}}"],
          "path": ["api", "ai-score", "generate"]
        }
      }
    },
    {
      "name": "查看评分报告",
      "request": {
        "method": "GET",
        "url": {
          "raw": "{{baseUrl}}/api/ai-score/report/P001",
          "host": ["{{baseUrl}}"],
          "path": ["api", "ai-score", "report", "P001"]
        }
      }
    }
  ],
  "variable": [
    {
      "key": "baseUrl",
      "value": "http://localhost:8080"
    }
  ]
}
```

## 🔍 故障排除

### 10. 常见问题解决

#### 应用无法启动
```bash
# 检查端口是否被占用
netstat -ano | findstr :8080

# 使用不同端口启动
java -jar target/ai-medical-score-1.0.0-SNAPSHOT.jar --server.port=8081
```

#### 数据库连接失败
检查配置文件中的数据库连接信息：
- 服务器地址：172.16.1.15:3306
- 数据库名：bailun
- 用户名/密码是否正确

#### API调用返回错误
```bash
# 查看详细错误日志
tail -f logs/ai-medical-score.log

# 或查看控制台输出
```

### 11. 日志查看

#### 查看应用日志
```bash
# Windows
type logs\ai-medical-score.log

# PowerShell
Get-Content logs\ai-medical-score.log -Tail 50
```

#### 查看特定时间的日志
```bash
# 查看最近100行日志
Get-Content logs\ai-medical-score.log -Tail 100 | Select-String "ERROR|WARN"
```

## 📊 性能监控

### 12. 监控应用状态

#### 内存使用情况
```
GET http://localhost:8080/actuator/metrics/jvm.memory.used
```

#### HTTP请求统计
```
GET http://localhost:8080/actuator/metrics/http.server.requests
```

#### 数据库连接池状态
```
GET http://localhost:8080/actuator/metrics/hikaricp.connections
```

## 🎯 实际使用场景

### 13. HMS系统集成测试

模拟HMS系统调用：
```bash
# 模拟获取患者信息
curl -X GET "http://172.16.1.13:10086/api/patient/P001" \
  -H "Authorization: Bearer d440578b-5ab3-4254-adf9-d9527503ae84"

# 模拟获取诊疗信息  
curl -X GET "http://172.16.1.13:10086/api/treatment/P001" \
  -H "Authorization: Bearer d440578b-5ab3-4254-adf9-d9527503ae84"
```

### 14. 评分结果分析

查看不同等级的评分结果：
- **甲级 (90-100分)**: 病历质量优秀
- **乙级 (75-89分)**: 病历质量良好  
- **丙级 (60-74分)**: 病历质量一般
- **不合格 (<60分)**: 需要改进

## ⚠️ 注意事项

1. **确保数据库连接正常** - MySQL服务器需要运行
2. **API密钥有效** - DeepSeek API密钥需要有足够余额
3. **网络连接** - 需要访问外部API服务
4. **内存要求** - 建议至少2GB可用内存
5. **JDK版本** - 需要JDK 17或更高版本

## 🆘 获取帮助

如遇到问题，请检查：
1. 应用日志文件
2. 数据库连接状态
3. 网络连接是否正常
4. API密钥是否有效

---

现在您可以按照这个指南逐步试用AI病历质控系统了！🎉 